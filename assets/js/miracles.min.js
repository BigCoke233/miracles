/*
 *  The main JavaScript file for Theme Miracles
 *
 *  @Author:  Eltrac
 *  @License: MIT
 */

/**
 *  Use cookies
 */
//add cookie
function addCookie(name, value, expireHours) {
    var cookieString = name + "=" + escape(value);
    if (expireHours > 0) {
        var date = new Date();
        date.setTime(date.getTime + expireHours * 3600 * 1000);
        cookieString = cookieString + "; expire=" + date.toGMTString();
    }
    document.cookie = cookieString;
}
//Delete cookie
function deleteCookie(name) {
    var date = new Date();
    date.setTime(date.getTime() - 10000);
    document.cookie = name + "=v; expire=" + date.toGMTString();
}
//Get cookie
function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

/**
 *  Base Animation
 *  Âü∫Á°ÄÂä®Áîª
 */
function scaleIn(object, time) {
    object.css('transition', time).css('transform', 'scale(0)');
    object.show();
    object.css('transform', 'scale(1)');
}

function scaleOut(object, time) {
    object.css('transition', time).css('transform', 'scale(0)')
}

function gotoPosition(e){
„ÄÄ„ÄÄvar t=e.offsetTop;
„ÄÄ„ÄÄvar l=e.offsetLeft;
„ÄÄ„ÄÄwhile(e=e.offsetParent){
„ÄÄ„ÄÄ„ÄÄ„ÄÄt+=e.offsetTop;
„ÄÄ„ÄÄ„ÄÄ„ÄÄl+=e.offsetLeft;
„ÄÄ„ÄÄ}
„ÄÄ„ÄÄ$("html,body").animate({scrollTop:t},300);
}

/**
 *  Dark theme
 */
 
//toggleDark
function Dark() {
    //Add classs to use dark theme
    $("body").toggleClass("body-dark");
    //Add cookie to record
    if ($("body").hasClass("body-dark")) {
        addCookie("darkTheme", "on", 9);
		$("#toggle-dark-button").html('<i class="iconfont icon-sun"></i>');
		$("#toggle-dark-mobile").html('<i class="iconfont icon-sun"></i>');
    } else {
        addCookie("darkTheme", "off", 9);
		$("#toggle-dark-button").html('<i class="iconfont icon-moon"></i>');
		$("#toggle-dark-mobile").html('<i class="iconfont icon-moon"></i>');
    }
}

/**
 *  Use filters
 */
//toggleGray
function Gray() {
    $("html").toggleClass("html-filter-gray");
    $("html").removeClass("html-filter-sepia");
    //add cookie to record
    if ($("html").hasClass("html-filter-gray")) {
        addCookie("grayFilter", "on", 0);
    } else {
        addCookie("grayFilter", "off", 0);
    }
}
//toggleSepia

function Sepia() {
    $("html").toggleClass("html-filter-sepia");
    $("html").removeClass("html-filter-gray");
    //add cookie to record
    if ($("html").hasClass("html-filter-sepia")) {
        addCookie("sepiaFilter", "on", 0);
    } else {
        addCookie("sepiaFilter", "off", 0);
    }
}

/**
 *  Explore and load themes/filter
 */
//explore and load dark theme
var whetherDark = getCookie("darkTheme");
var schemeGeter = window.matchMedia ("(prefers-color-scheme: dark)");
if (whetherDark == "on" || schemeGeter.matches) {
    $("body").addClass("body-dark");
	$("#toggle-dark-button").html('<i class="iconfont icon-sun"></i>');
	$("#toggle-dark-mobile").html('<i class="iconfont icon-sun"></i>');
} 
//ÊîØÊåÅÁ≥ªÁªüÊ∑±Ëâ≤Ê®°Âºè
function swDarkMode(scheme){
    if(scheme.matches)
    $("body").addClass("body-dark");
    else if(window.matchMedia ("(prefers-color-scheme: light)").matches)
    $("body").removeClass("body-dark");
}
schemeGeter.addListener(swDarkMode);

/**
 *  GoTop
 */
function GoTop() {
    $('body,html').animate({
        scrollTop: 0
    }, 500);
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
}
$('#gotop').hide();
$(window).scroll(function() {
    if ($(window).scrollTop() > 450) {
        scaleIn($('#gotop'), '0.7');
    } else {
        scaleOut($('#gotop'), '0.7');
    }
});

/**
 *  Nav
 */
var new_scroll_position = 0;
var last_scroll_position;
var header = $(".nav");

window.addEventListener('scroll', function(e) {
last_scroll_position = window.scrollY;
 
// Âêë‰∏ãÊªöÂä®
if (new_scroll_position < last_scroll_position && last_scroll_position > 80) {
  header.removeClass("nav-slideDown");
  header.addClass("nav-slideUp");
 
// Âêë‰∏äÊªöÂä®
} else if (new_scroll_position > last_scroll_position) {
  header.removeClass("nav-slideUp");
  header.addClass("nav-slideDown");
}
 
new_scroll_position = last_scroll_position;
}); 

/**
 *  Js Loader
 */
//LazyLoad
function LazyLoad() {
    jQuery(function() {
        jQuery("img").lazyload({
            threshold: 200,
            effect: "fadeIn"
        });
    });
}
//highlight

function highlight() {
    $(document).ready(function() {
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block);
            hljs.lineNumbersBlock(block, {
                singleLine: true
            });
        })
    });
}
//owo

function owoLoad() {
    var OwO_demo = new OwO({
        logo: 'OœâOË°®ÊÉÖ',
        container: document.getElementsByClassName('OwO')[0],
        target: document.getElementsByClassName('OwO-textarea')[0],
        api: owoJson,
        position: 'down',
        width: '300px',
        maxHeight: '250px'
    });
}
//Pangu.js

function panguLoad() {
    document.addEventListener('DOMContentLoaded', () => {
        pangu.autoSpacingPage();
    });
}

/**
 *  Prevent Scroll
 */
function bodyScroll(event) {
    event.preventDefault();
}

/**
 *  Open pannel
 */
//Search
function Search() {
    $(".search").toggleClass("ready");
    $(".search-close").toggleClass("ready");
}
//Login

function Login() {
    $(".login").toggleClass("ready");
    $(".login-close").toggleClass("ready");
    //Ban or allow scroll
}

/**
 *  Drawer
 */
function toggleDrawer() {
    $("body").toggleClass("drawer-open");
    $(".mask").toggleClass("mask-open");
}

/**
 *  Alert
 */
function alertSend(content, type) {
	$("body").append("<div class=\"alert adding " + type + "\">"+ content +"</div>");
    window.setTimeout(function() {
		$(".alert").removeClass("adding");
        $(".alert").addClass("remove");
		window.setTimeout(function() {
			$(".alert").remove();
		}, 200);
    }, 2000);
}

/**
 *  Listen copy event and alert
 */
var copyAlertTime = 0;
$(document).ready(function() {
    $("body").bind({
        copy: function() {
			copyAlertTime++;
			if(copyAlertTime == 1) {
              alertSend("Â§çÂà∂ÊàêÂäüÔºÅËã•‰ΩøÁî®ËØ∑Ê≥®ÊòéÂéü‰ΩúËÄÖÂèäÂéüÂú∞ÂùÄÔºÅ");
		      window.setTimeout(function() {
				  copyAlertTime = 0;
			  }, 200);
			}
        }
    });
});

/**
 *  Event Listeners
 */
/* GetElementById */
function idGetEl(id) {
    var el = document.getElementById(id);
    return el;
}

/* Find Elements */
var goTopButton = idGetEl("gotop");
var fullMask = idGetEl("full-mask");
var searchCloseButton = idGetEl("search-close-button");
var searchOpenButton = idGetEl("search-open-button");
var searchOpenMobile = idGetEl("search-open-mobile");
var loginCloseButton = idGetEl("login-close");
var loginOpenButton = idGetEl("login-open");
var loginOpenMobile = idGetEl("login-open-mobile");
var toggleMobileMenuClose = idGetEl("toggle-mobile-menu-close");
var toggleMobileMenu = idGetEl("toggle-mobile-menu-button");
var drawerButton = idGetEl("drawer-button");
var navBar = idGetEl("navBar");
var navBarMobile = idGetEl("navBarMobile");
var darkToggle = idGetEl("toggle-dark-button");
var darkToggleMobile = idGetEl("toggle-dark-mobile");

/* Add Listeners */
//ËøîÂõûÈ°∂ÈÉ®ÊåâÈíÆ
goTopButton.addEventListener("click", GoTop);
//ÂÖ®Â±èÈÅÆÁΩ©ÔºàÊäΩÂ±âÊ†èÔºâ
fullMask.addEventListener("click", function() {
    toggleDrawer();
    $('.options').addClass('ready');
});
//ÊâìÂºÄ/ÂÖ≥Èó≠ÊêúÁ¥¢Èù¢Êùø
searchCloseButton.addEventListener("click", Search);
searchOpenButton.addEventListener("click", Search);
searchOpenMobile.addEventListener("click", Search);
//ÊâìÂºÄ/ÂÖ≥Èó≠ÁôªÂΩïÈù¢Êùø
loginCloseButton.addEventListener("click", Login);
loginOpenButton.addEventListener("click", Login);
loginOpenMobile.addEventListener("click", Login);
//ÂºÄÂÖ≥ÁßªÂä®Á´ØÂØºËà™
toggleMobileMenuClose.addEventListener("click", function() {
    $(".mobile-menu").toggleClass("ready");
    $(".mobile-menu-close").toggleClass("ready");
});
toggleMobileMenu.addEventListener("click", function() {
    $(".mobile-menu").toggleClass("ready");
    $(".mobile-menu-close").toggleClass("ready");
});
//ÂàáÊç¢Â§úÈó¥Ê®°Âºè
darkToggle.addEventListener("click", Dark);
darkToggleMobile.addEventListener("click", Dark);


/**
 *  Load Pjax
 */
if (loadPjax = true) {
    $(document).pjax('a[href^="' + siteurl + '"]:not(a[target="_blank"], a[no-pjax], .comment-reply a, .cancel-comment-reply a)', {
        container: '#pjax-container',
        fragment: '#pjax-container',
        timeout: 8000
    }).on('pjax:send', function() {
        GoTop();
        //Others
        beforePjax();
    }).on('pjax:complete', function() {
        //Front-end Login
        $('form#login-form').addClass('need-refresh');
        //Close Mobile Menu after pjax finishes
        $(".mobile-menu").addClass("ready");
        $(".mobile-menu-close").addClass("ready");
        //Animation
        $(".post-list").addClass("fadein").hide().fadeIn(300);
        $(".post-body").addClass("fadein").hide().fadeIn(300);
        $(".comment").addClass("fadein").hide().fadeIn(300);
        $("#pjax-container").css({
            'height': 'auto'
        });
        //NProgress
        NProgress.done();
        //Reload
        LazyLoad();
        highlight();
        panguLoad();
        getWordsNum();
        navColor();
        MiraclesComment.bindReplyBtn(); //Bind Reply Button
        MiraclesComment.core(); //Comment Core
        //Others
        afterPjax();
    });
}

/**
 *  Comply First
 */
(function() {
    panguLoad();
    LazyLoad();
    highlight();
    navUpdate();
    getWordsNum();
    navColor();
})();
/**
 * NavBar Scroll Change
 */
var navBar_height = navBar.clientHeight;

    function navUpdate() {
		if(allowNavAero==true) {
            var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            if (scrollTop > navBar_height) {
                navBar.classList.remove("nav-aero");
                navBarMobile.classList.remove("nav-aero");
				$(".nav-icon-button").css("color", "#000");
            } else {
                navBar.classList.add("nav-aero");
                navBarMobile.classList.add("nav-aero");
				if ($(".index-banner").css("background-image")=="url('')") {
					$(".nav-icon-button").css("color", "#000");
				}
				else {
					$(".nav-icon-button").css("color", "#fff");
				}
            }
		}
    }
$(window).scroll(function() {
    navUpdate();
})
/**
 * Navbar font update
 */
function navColor() {
    if (idGetEl("banner-content").className.indexOf("banner-font-black") == -1) {
        navBar.classList.add("nav-font-white");
        navBarMobile.classList.add("nav-font-white");
    } else {
        navBar.classList.remove("nav-font-white");
        navBarMobile.classList.remove("nav-font-white");
    }
}
/**
 * getWordsNum
 */
function getWordsNum() {
    if (idGetEl("post-content"))
        str = idGetEl("post-content").innerText;
    else return false;
    sLen = 0;
    str = str.replace(/(\r\n+|\s+|„ÄÄ+)/g, "Èæò");
    str = str.replace(/[\x00-\xff]/g, "m");
    str = str.replace(/m+/g, "*");
    str = str.replace(/Èæò+/g, "");
    sLen = str.length;
    time = Math.ceil(sLen / 450);
    idGetEl("readTip").innerHTML = "Êú¨ÊñáÁ∫¶ " + sLen + "Â≠ó ÈòÖËØªÂ§ßÊ¶ÇÈúÄË¶Å " + time + " ÂàÜÈíü";
}
/**
 * Build Time Echo
 */
function startTime(time = '2010-01-01') {
    startTimeV = time;
    var $time = new Date().getTime() - new Date(startTimeV);
    if ($time < 0) return '0Áßí';
    let result = '';
    if ($time >= 365 * 86400000) {
        result += parseInt($time / (365 * 86400000)) + ' Âπ¥ ';
        $time = ($time % (365 * 86400000));
    }
    if ($time >= 86400000) {
        result += parseInt($time / 86400000) + ' Â§© ';
        $time = ($time % 86400000);
    }
    if ($time >= 3600000) {
        result += parseInt($time / 3600000) + ' Â∞èÊó∂ ';
        $time = ($time % 3600000);
    }
    if ($time >= 60000) {
        result += parseInt($time / 60000) + ' ÂàÜ ';
        $time = ($time % 60000);
    }
    result += parseInt($time / 1000) + ' Áßí ';
    $('#build-time').html(result);
    buildTimeout = setTimeout('startTime(startTimeV)', 1000)
}

/**
 * Â§ñÈÉ®ÈìæÊé•Êñ∞Á™óÂè£ÊâìÂºÄ
 */
 

function linkTarget() {
    var all_a = document.getElementsByTagName("a");
    host_url=window.location.host;
    for (var i = 0; i < all_a.length; i++) {
        var domain = all_a[i].href.split("/"); //‰ª•‚Äú/‚ÄùËøõË°åÂàÜÂâ≤
        if (domain[2]!=host_url) {
            all_a[i].target = "_blank";
        }
    }
}
linkTarget();

console.log("%c üéâ Theme Miracles %c by Eltrac https://guhub.cn %c ", "color: #fff; margin: 1em 0; padding: 5px 0; background: #29c75f;", "margin: 1em 0; padding: 5px 0; background: #efefef;", "display: block;margin-left:-0.5em;");