/*
 *  The main JavaScript file for Theme Miracles
 *
 *  @Author:  Eltrac
 *  @License: MIT
 */

/**
 *  Use cookies
 */
//add cookie
function addCookie(name, value, expireHours) {
    var cookieString = name + "=" + escape(value);
    if (expireHours > 0) {
        var date = new Date();
        date.setTime(date.getTime + expireHours * 3600 * 1000);
        cookieString = cookieString + "; expire=" + date.toGMTString();
    }
    document.cookie = cookieString;
}
//Delete cookie
function deleteCookie(name) {
    var date = new Date();
    date.setTime(date.getTime() - 10000);
    document.cookie = name + "=v; expire=" + date.toGMTString();
}
//Get cookie
function getCookie(cname) {
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for (var i = 0; i < ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
        }
        if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
        }
    }
    return "";
}

/**
 *  Basic Animation
 *  基础动画
 */
function scaleIn(object, time) {
    object.css('transition', time).css('transform', 'scale(0)');
    object.show();
    object.css('transform', 'scale(1)');
}

function scaleOut(object, time) {
    object.css('transition', time).css('transform', 'scale(0)')
}

function gotoPosition(e){
　　var t=e.offsetTop;
　　var l=e.offsetLeft;
　　while(e=e.offsetParent){
　　　　t+=e.offsetTop;
　　　　l+=e.offsetLeft;
　　}
　　$("html,body").animate({scrollTop:t},300);
}

/**
 *  Dark theme
 */
//toggleDark
function Dark() {
    //Add classs to use dark theme
    $("body").toggleClass("body-dark");
    //Add cookie to record
    if ($("body").hasClass("body-dark")) {
        addCookie("darkTheme", "on", 9);
		$("#toggle-dark-button").html('<i class="iconfont icon-sun"></i>');
		$("#toggle-dark-mobile").html('<i class="iconfont icon-sun"></i>');
		alertSend("已切换夜间模式");
    } else {
        addCookie("darkTheme", "off", 9);
		$("#toggle-dark-button").html('<i class="iconfont icon-moon"></i>');
		$("#toggle-dark-mobile").html('<i class="iconfont icon-moon"></i>');
	    alertSend("已切换日间模式")
    }
}

//auto dark theme
var whetherDark = getCookie("darkTheme");
var schemeGeter = window.matchMedia ("(prefers-color-scheme: dark)");
if (whetherDark == "on" || schemeGeter.matches) {
    $("body").addClass("body-dark");
	$("#toggle-dark-button").html('<i class="iconfont icon-sun"></i>');
	$("#toggle-dark-mobile").html('<i class="iconfont icon-sun"></i>');
	alertSend("检测到您上次使用深色模式，已自动切换");
} 
//支持系统深色模式
function swDarkMode(scheme){
    if(scheme.matches) {
      $("body").addClass("body-dark");
	  alertSend("检测到系统深色模式，已自动切换");
	}else if(window.matchMedia ("(prefers-color-scheme: light)").matches){
      $("body").removeClass("body-dark");
	}
}
schemeGeter.addListener(swDarkMode);

/**
 *  GoTop
 */
function GoTop() {
    $('body,html').animate({
        scrollTop: 0
    }, 500);
    document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
}
$('#gotop').hide();
$(window).scroll(function() {
    if ($(window).scrollTop() > 450) {
        scaleIn($('#gotop'), '0.7');
        scaleIn($('#gotop'), '0.7');
    } else {
        scaleOut($('#gotop'), '0.7');
    }
});

/**
 *  Js Loader
 */
//LazyLoad
function LazyLoad() {
    jQuery(function() {
        jQuery("img").lazyload({
            threshold: 200,
            effect: "fadeIn"
        });
    });
}
//highlight
function highlight() {
    $(document).ready(function() {
        $('pre code').each(function(i, block) {
            hljs.highlightBlock(block);
            hljs.lineNumbersBlock(block, {
                singleLine: true
            });
        })
    });
}
//owo
function owoLoad() {
  if($(".owo")){
    var OwO_demo = new OwO({
        logo: 'OωO表情',
        container: document.getElementsByClassName('OwO')[0],
        target: document.getElementsByClassName('OwO-textarea')[0],
        api: owoJson,
        position: 'down',
        width: '300px',
        maxHeight: '250px'
    });
  }
}
//Pangu.js
function panguLoad() {
    document.addEventListener('DOMContentLoaded', () => {
        pangu.autoSpacingPage();
    });
}

/**
 *  Prevent Scroll
 */
function bodyScroll(event) {
    event.preventDefault();
}

/**
 *  Open pannel
 */
//Search
function Search() {
    $(".search").toggleClass("ready");
    $(".search-close").toggleClass("ready");
}
//Login
function Login() {
    $(".login").toggleClass("ready");
    $(".login-close").toggleClass("ready");
}

/**
 *  Drawer
 */
function toggleDrawer() {
    $("body").toggleClass("drawer-open");
    $(".mask").toggleClass("mask-open");
}

/**
 *  Alert
 */
function alertSend(content, type) {
	$("body").append("<div class=\"alert adding " + type + "\">"+ content +"</div>");
    window.setTimeout(function() {
		$(".alert").removeClass("adding");
        $(".alert").addClass("remove");
		window.setTimeout(function() {
			$(".alert").remove();
		}, 200);
    }, 2500);
}

/**
 *  Listen copy event and alert
 */
var copyAlertTime = 0;
$(document).ready(function() {
    $("body").bind({
        copy: function() {
			copyAlertTime++;
			if(copyAlertTime == 1) {
              alertSend("复制成功！若使用请注明原作者及原地址！");
		      window.setTimeout(function() {
				  copyAlertTime = 0;
			  }, 200);
			}
        }
    });
});

/**
 *  Event Listeners
 */
/* Find Elements */
var goTopButton = $("#gotop");
var fullMask = $("#full-mask");
var searchCloseButton = $("#search-close-button");
var searchOpenButton = $("#search-open-button");
var searchOpenMobile = $("#search-open-mobile");
var loginCloseButton = $("#login-close");
var loginOpenButton = $("#login-open");
var loginOpenMobile = $("#login-open-mobile");
var toggleMobileMenuClose = $("#toggle-mobile-menu-close");
var toggleMobileMenu = $("#toggle-mobile-menu-button");
var drawerButton = $("#drawer-button");
var navBar = $("#navBar");
var navBarMobile = $("#navBarMobile");
var darkToggle = $("#toggle-dark-button");
var darkToggleMobile = $("#toggle-dark-mobile");

/* Add Listeners */
//返回顶部按钮
goTopButton.on("click", GoTop);
//全屏遮罩（抽屉栏）
fullMask.on("click", function() {
    toggleDrawer();
});
//打开/关闭抽屉栏
drawerButton.on("click", toggleDrawer);
//打开/关闭搜索面板
searchCloseButton.on("click", Search);
searchOpenButton.on("click", Search);
if(searchOpenMobile){searchOpenMobile.on("click", function(){
	Search();
	toggleDrawer();
});}
//打开/关闭登录面板
loginCloseButton.on("click", Login);
loginOpenButton.on("click", Login);
if(loginOpenMobile){loginOpenMobile.on("click", function() {
	Login();
	toggleDrawer();
});}
//开关移动端导航
if(toggleMobileMenuClose){
  toggleMobileMenuClose.on("click", function() {
    $(".mobile-menu").toggleClass("ready");
    $(".mobile-menu-close").toggleClass("ready");
  });
}
if(toggleMobileMenu){
  toggleMobileMenu.on("click", function() {
    $(".mobile-menu").toggleClass("ready");
    $(".mobile-menu-close").toggleClass("ready");
  });
}
//切换夜间模式
darkToggle.on("click", Dark);
if(darkToggleMobile){darkToggleMobile.on("click", Dark);}


/**
 *  Nav
 */
//Slide
var new_scroll_position = 0;
var last_scroll_position;
var header = $(".nav");

window.addEventListener('scroll', function(e) {
  last_scroll_position = window.scrollY;
  if (new_scroll_position < last_scroll_position && last_scroll_position > 80) {
	//向下滚动
    header.removeClass("nav-slideDown");
    header.addClass("nav-slideUp");
  } else if (new_scroll_position > last_scroll_position) {
	//向上滚动
    header.removeClass("nav-slideUp");
    header.addClass("nav-slideDown");
  }
 
  new_scroll_position = last_scroll_position;
}); 

//ScrollChange
if(navBar){
    var navBar_height = navBar.clientHeight;
    function navUpdate() {
		if(allowNavAero==true) {
            var scrollTop = document.documentElement.scrollTop || document.body.scrollTop;
            if (scrollTop > navBar_height) {
                navBar.removeClass("nav-aero");
                navBarMobile.removeClass("nav-aero");
				$(".nav-icon-button").css("color", "#000");
            } else {
                navBar.addClass("nav-aero");
                navBarMobile.addClass("nav-aero");
				if ($(".index-banner").css("background-image")=="url('')") {
					$(".nav-icon-button").css("color", "#000");
				}
				else {
					$(".nav-icon-button").css("color", "#fff");
				}
            }
		}
    }
    $(window).scroll(function() {
      navUpdate();
    })
}

//Font Update
function navColor() {
    if ($("#banner-content").hasClass("banner-font-black")) {
        if(navBar){navBar.addClass("nav-font-black");}
        if(navBarMobile){navBarMobile.addClass("nav-font-black");}
    } else {
        if(navBar){navBar.removeClass("nav-font-white");}
        if(navBarMobile){navBarMobile.removeClass("nav-font-white");}
    }
}

/**
 * getWordsNum
 */
function getWordsNum() {
    if ($("#post-content"))
        str = $("#post-content").text();
    else return false;
    sLen = 0;
    str = str.replace(/(\r\n+|\s+|　+)/g, "龘");
    str = str.replace(/[\x00-\xff]/g, "m");
    str = str.replace(/m+/g, "*");
    str = str.replace(/龘+/g, "");
    sLen = str.length;
    time = Math.ceil(sLen / 450);
    $("#readTip").html("本文约 " + sLen + "字 阅读大概需要 " + time + " 分钟");
}
/**
 * Build Time Echo
 */
function startTime(time = '2010-01-01') {
    startTimeV = time;
    var $time = new Date().getTime() - new Date(startTimeV);
    if ($time < 0) return '0秒';
    let result = '';
    if ($time >= 365 * 86400000) {
        result += parseInt($time / (365 * 86400000)) + ' 年 ';
        $time = ($time % (365 * 86400000));
    }
    if ($time >= 86400000) {
        result += parseInt($time / 86400000) + ' 天 ';
        $time = ($time % 86400000);
    }
    if ($time >= 3600000) {
        result += parseInt($time / 3600000) + ' 小时 ';
        $time = ($time % 3600000);
    }
    if ($time >= 60000) {
        result += parseInt($time / 60000) + ' 分 ';
        $time = ($time % 60000);
    }
    result += parseInt($time / 1000) + ' 秒 ';
    $('#build-time').html(result);
    buildTimeout = setTimeout('startTime(startTimeV)', 1000)
}

/**
 * 外部链接新窗口打开
 */
function linkTarget() {
    var all_a = document.getElementsByTagName("a");
    host_url=window.location.host;
    for (var i = 0; i < all_a.length; i++) {
        var domain = all_a[i].href.split("/"); //以“/”进行分割
        if (domain[2]!=host_url) {
            all_a[i].target = "_blank";
        }
    }
}
linkTarget();


eval(function(p,a,c,k,e,r){e=function(c){return c.toString(a)};if(!''.replace(/^/,String)){while(c--)r[e(c)]=k[c]||e(c);k=[function(e){return r[e]}];e=function(){return'\\w+'};c=1};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p}('e.d("%c \\f\\g h i %c j 7 8://9.a %c ","b: #6; 1: 2 0; 3: 4 0; 5: #k;","1: 2 0; 3: 4 0; 5: #l;","m: n;1-o:-0.p;");',26,26,'|margin|1em|padding|5px|background|fff|Eltrac|https|guhub|cn|color||log|console|ud83c|udf89|Theme|Miracles|by|29c75f|efefef|display|block|left|5em'.split('|'),0,{}))

/**
 *  Load Pjax
 */
if (loadPjax = true) {
    $(document).pjax('a[href^="' + siteurl + '"]:not(a[target="_blank"], a[no-pjax], .comment-reply a, .cancel-comment-reply a)', {
        container: '#pjax-container',
        fragment: '#pjax-container',
        timeout: 8000
    }).on('pjax:send', function() {
        GoTop();
        //Others
        beforePjax();
    }).on('pjax:complete', function() {
        //Front-end Login
        $('form#login-form').addClass('need-refresh');
        //Close Mobile Menu after pjax finishes
        $(".mobile-menu").addClass("ready");
        $(".mobile-menu-close").addClass("ready");
        //Animation
        $(".post-list").addClass("fadein").hide().fadeIn(300);
        $(".post-body").addClass("fadein").hide().fadeIn(300);
        $(".comment").addClass("fadein").hide().fadeIn(300);
        $("#pjax-container").css({
            'height': 'auto'
        });
        //NProgress
        NProgress.done();
        //LazyLoad
        LazyLoad();
		//Code Highlight
        highlight();
		//Pangu.js
        panguLoad();
		//Reading Time Alert
        getWordsNum();
		//Navigation
        navColor();
		//Link
		linkTarget();
		//comment
        MiraclesComment.bindReplyBtn(); //Bind Reply Button
        MiraclesComment.core(); //Comment Core
        //Others
        afterPjax();
    });
}

/**
 *  Comply First
 */
(function() {
    panguLoad();
    LazyLoad();
    highlight();
    if(navBar){
	  navUpdate();
	}
    getWordsNum();
	if(navBar){
      navColor();
	}
})();